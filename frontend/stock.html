<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Investment Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .refresh-btn {
            margin-top: 15px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 15px;
        }

        .investment-icon {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .portfolio-icon {
            background: linear-gradient(45deg, #f093fb, #f5576c);
            color: white;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stock-recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stock-card {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stock-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .stock-card.selected {
            border-color: #667eea;
            background: #e7f0ff;
        }

        .stock-symbol {
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 5px;
        }

        .stock-price {
            font-size: 1.1rem;
            font-weight: 600;
            color: #667eea;
            margin: 8px 0;
        }

        .stock-change {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .stock-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .stock-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .portfolio-grid {
            display: grid;
            gap: 15px;
            margin-top: 20px;
        }

        .portfolio-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }

        .portfolio-symbol {
            font-weight: bold;
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 8px;
        }

        .portfolio-details {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .portfolio-gain {
            font-weight: 600;
            font-size: 1rem;
        }

        .portfolio-gain.positive {
            color: #28a745;
        }

        .portfolio-gain.negative {
            color: #dc3545;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .insights {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .insights h4 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3rem;
        }

        .insight-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .insight-item h5 {
            margin-bottom: 8px;
            color: #333;
        }

        .insight-item p {
            color: #666;
            line-height: 1.5;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìà Stock Investment Analyzer</h1>
            <p>Real-Time Investment Analysis</p>
            <button class="btn refresh-btn" onclick="refreshAllData()">üîÑ Refresh Market Data</button>
        </div>

        <div class="dashboard">
            <!-- Investment Analysis Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon investment-icon">üìä</div>
                    <h3>Investment Analysis</h3>
                </div>
                <div class="input-group">
                    <label for="investment-amount">Investment Amount ($):</label>
                    <input type="number" id="investment-amount" placeholder="e.g., 1000" step="0.01">
                </div>
                <div class="input-group">
                    <label for="risk-tolerance">Risk Tolerance:</label>
                    <select id="risk-tolerance">
                        <option value="conservative">üõ°Ô∏è Conservative (Low Risk)</option>
                        <option value="moderate">‚öñÔ∏è Moderate (Medium Risk)</option>
                        <option value="aggressive">üöÄ Aggressive (High Risk)</option>
                    </select>
                </div>
                <button class="btn" onclick="getStockRecommendations()">Get Real-Time Recommendations</button>
                
                <div id="stock-recommendations" class="stock-recommendations"></div>
            </div>

            <!-- Portfolio Management Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon portfolio-icon">üíº</div>
                    <h3>Investment Portfolio</h3>
                </div>
                <div class="input-group">
                    <label for="selected-stock">Selected Stock:</label>
                    <select id="selected-stock">
                        <option value="">Choose a stock to invest</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="investment-shares">Number of Shares:</label>
                    <input type="number" id="investment-shares" placeholder="e.g., 10" step="1" min="1">
                </div>
                <button class="btn" onclick="addToPortfolio()">Add to Portfolio</button>
                
                <div id="portfolio-display" class="portfolio-grid"></div>
            </div>
        </div>

        <!-- Portfolio Statistics -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(45deg, #FF6B6B, #FF8E53); color: white;">üìà</div>
                <h3>Portfolio Performance</h3>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-value" id="total-invested">$0</div>
                    <div class="stat-label">Total Invested</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="current-value">$0</div>
                    <div class="stat-label">Current Value</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="total-gain-loss">$0</div>
                    <div class="stat-label">Total Gain/Loss</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="portfolio-return">0%</div>
                    <div class="stat-label">Portfolio Return</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Investment Insights -->
        <div class="insights">
            <h4>ü§ñ AI Investment Insights & Analysis</h4>
            <div id="investment-insights-container"></div>
        </div>
    </div>

    <script>
        // Global variables for stock market
        let stockData = [];
        let portfolio = [];
        let selectedStocks = [];
        let portfolioChart = null;
        let priceUpdateInterval = null;

        // Real stock symbols organized by risk category
        const stockDatabase = {
            conservative: [
                { symbol: 'AAPL', name: 'Apple Inc.', sector: 'Technology' },
                { symbol: 'MSFT', name: 'Microsoft Corp.', sector: 'Technology' },
                { symbol: 'JNJ', name: 'Johnson & Johnson', sector: 'Healthcare' },
                { symbol: 'PG', name: 'Procter & Gamble', sector: 'Consumer Goods' },
                { symbol: 'KO', name: 'Coca-Cola', sector: 'Beverages' }
            ],
            moderate: [
                { symbol: 'GOOGL', name: 'Alphabet Inc.', sector: 'Technology' },
                { symbol: 'AMZN', name: 'Amazon.com Inc.', sector: 'E-commerce' },
                { symbol: 'TSLA', name: 'Tesla Inc.', sector: 'Automotive' },
                { symbol: 'NVDA', name: 'NVIDIA Corp.', sector: 'Semiconductors' },
                { symbol: 'META', name: 'Meta Platforms', sector: 'Social Media' }
            ],
            aggressive: [
                { symbol: 'AMD', name: 'Advanced Micro Devices', sector: 'Semiconductors' },
                { symbol: 'NFLX', name: 'Netflix Inc.', sector: 'Streaming' },
                { symbol: 'SQ', name: 'Block Inc.', sector: 'Fintech' },
                { symbol: 'ROKU', name: 'Roku Inc.', sector: 'Streaming Tech' },
                { symbol: 'PLTR', name: 'Palantir Technologies', sector: 'Data Analytics' }
            ]
        };

        // API configuration - Using Alpha Vantage free tier
        const API_KEY = 'https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=IBM&interval=5min&apikey=demo'; // Replace with your actual API key from Alpha Vantage
        const API_BASE_URL = 'https://www.alphavantage.co/query';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadPortfolioData();
            updatePortfolioDisplay();
            // Start price updates every 5 minutes (free tier limitation)
            startPriceUpdates();
        });

        // Fetch real-time stock data from Alpha Vantage API
        async function fetchRealTimeStockData(symbol) {
            try {
                const response = await fetch(`${API_BASE_URL}?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY}`);
                const data = await response.json();
                
                if (data['Global Quote']) {
                    const quote = data['Global Quote'];
                    return {
                        symbol: symbol,
                        currentPrice: parseFloat(quote['05. price']),
                        change: parseFloat(quote['09. change']),
                        changePercent: parseFloat(quote['10. change percent'].replace('%', '')),
                        lastUpdated: new Date()
                    };
                } else {
                    throw new Error('API limit reached or invalid response');
                }
            } catch (error) {
                console.error(`Error fetching data for ${symbol}:`, error);
                // Fallback to demo data if API fails
                return {
                    symbol: symbol,
                    currentPrice: 100 + Math.random() * 300,
                    change: (Math.random() - 0.5) * 10,
                    changePercent: (Math.random() - 0.5) * 10,
                    lastUpdated: new Date(),
                    isDemo: true
                };
            }
        }

        // Alternative API function using Financial Modeling Prep (free tier)
        async function fetchStockDataFMP(symbol) {
            try {
                // Using free tier - no API key required for basic quotes
                const response = await fetch(`https://financialmodelingprep.com/api/v3/quote-short/${symbol}?apikey=demo`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    const quote = data[0];
                    return {
                        symbol: symbol,
                        currentPrice: quote.price,
                        change: quote.change || 0,
                        changePercent: quote.changesPercentage || 0,
                        lastUpdated: new Date()
                    };
                } else {
                    throw new Error('No data available');
                }
            } catch (error) {
                console.error(`Error fetching FMP data for ${symbol}:`, error);
                return null;
            }
        }

        // Fetch stock data using Yahoo Finance alternative (through RapidAPI)
        async function fetchStockDataYahoo(symbols) {
            try {
                // Using a public Yahoo Finance API alternative
                const symbolString = symbols.join(',');
                const response = await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${symbolString}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    }
                });
                const data = await response.json();
                
                if (data.quoteResponse && data.quoteResponse.result) {
                    return data.quoteResponse.result.map(quote => ({
                        symbol: quote.symbol,
                        currentPrice: quote.regularMarketPrice || quote.bid || 0,
                        change: quote.regularMarketChange || 0,
                        changePercent: quote.regularMarketChangePercent || 0,
                        lastUpdated: new Date()
                    }));
                }
            } catch (error) {
                console.error('Yahoo Finance API error:', error);
            }
            return null;
        }

        // Save portfolio data
        function savePortfolioData() {
            const data = {
                portfolio: portfolio,
                stockData: stockData
            };
            window.portfolioData = data;
        }

        // Load portfolio data
        function loadPortfolioData() {
            if (window.portfolioData) {
                const data = window.portfolioData;
                portfolio = data.portfolio || [];
                stockData = data.stockData || [];
            }
        }

        // Get stock recommendations with real-time data
        async function getStockRecommendations() {
            const amount = parseFloat(document.getElementById('investment-amount').value) || 0;
            const riskTolerance = document.getElementById('risk-tolerance').value;
            
            if (amount < 100) {
                alert('Please enter an investment amount of at least $100');
                return;
            }

            const container = document.getElementById('stock-recommendations');
            container.innerHTML = '<div class="loading">üìä Fetching real-time stock data...</div>';

            const recommendedStocks = stockDatabase[riskTolerance] || stockDatabase.moderate;
            const symbols = recommendedStocks.map(stock => stock.symbol);

            try {
                // Try Yahoo Finance API first
                let stockPrices = await fetchStockDataYahoo(symbols);
                
                // If Yahoo fails, try individual API calls
                if (!stockPrices) {
                    stockPrices = [];
                    for (const stock of recommendedStocks) {
                        const priceData = await fetchStockDataFMP(stock.symbol);
                        if (priceData) {
                            stockPrices.push(priceData);
                        } else {
                            // Fallback to demo data
                            stockPrices.push({
                                symbol: stock.symbol,
                                currentPrice: 100 + Math.random() * 300,
                                change: (Math.random() - 0.5) * 10,
                                changePercent: (Math.random() - 0.5) * 10,
                                lastUpdated: new Date(),
                                isDemo: true
                            });
                        }
                        // Add delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 200));
                    }
                }

                // Combine stock info with price data
                stockData = recommendedStocks.map(stock => {
                    const priceData = stockPrices.find(p => p.symbol === stock.symbol);
                    return {
                        ...stock,
                        currentPrice: priceData ? priceData.currentPrice : 100 + Math.random() * 300,
                        change: priceData ? priceData.changePercent : (Math.random() - 0.5) * 10,
                        lastUpdated: new Date(),
                        isDemo: !priceData || priceData.isDemo
                    };
                });

                displayStockRecommendations(amount);
                updateStockSelect();
                savePortfolioData();

            } catch (error) {
                console.error('Error fetching stock data:', error);
                container.innerHTML = '<div class="error">‚ö†Ô∏è Unable to fetch real-time data. Using demo data instead.</div>';
                
                // Fallback to demo data
                stockData = recommendedStocks.map(stock => ({
                    ...stock,
                    currentPrice: 100 + Math.random() * 300,
                    change: (Math.random() - 0.5) * 10,
                    lastUpdated: new Date(),
                    isDemo: true
                }));
                
                setTimeout(() => {
                    displayStockRecommendations(amount);
                    updateStockSelect();
                    savePortfolioData();
                }, 1000);
            }
        }

        // Display stock recommendations
        function displayStockRecommendations(investmentAmount) {
            const container = document.getElementById('stock-recommendations');
            container.innerHTML = '';

            stockData.forEach((stock, index) => {
                const affordableShares = Math.floor(investmentAmount / stock.currentPrice);
                const changeClass = stock.change >= 0 ? 'positive' : 'negative';
                const changeSymbol = stock.change >= 0 ? '+' : '';
                
                const stockCard = document.createElement('div');
                stockCard.className = 'stock-card';
                stockCard.onclick = () => selectStock(index);
                stockCard.innerHTML = `
                    <div class="stock-symbol">${stock.symbol}${stock.isDemo ? ' üî¥' : ' üü¢'}</div>
                    <div style="font-size: 0.8rem; color: #666; margin: 2px 0;">${stock.name}</div>
                    <div class="stock-price">$${stock.currentPrice.toFixed(2)}</div>
                    <div class="stock-change ${changeClass}">
                        ${changeSymbol}${stock.change.toFixed(2)}%
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                        üìä ${stock.sector}<br>
                        üí∞ Can buy: ${affordableShares} shares<br>
                        ‚è∞ ${stock.lastUpdated.toLocaleTimeString()}
                    </div>
                `;
                container.appendChild(stockCard);
            });

            // Add legend
            const legend = document.createElement('div');
            legend.style.gridColumn = '1/-1';
            legend.style.fontSize = '0.8rem';
            legend.style.color = '#666';
            legend.style.textAlign = 'center';
            legend.style.marginTop = '10px';
            legend.innerHTML = 'üü¢ Real-time data | üî¥ Demo data (API limit reached)';
            container.appendChild(legend);
        }

        // Select stock for investment
        function selectStock(index) {
            document.querySelectorAll('.stock-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            document.querySelectorAll('.stock-card')[index].classList.add('selected');
            
            const selectElement = document.getElementById('selected-stock');
            selectElement.value = stockData[index].symbol;
        }

        // Update stock select dropdown
        function updateStockSelect() {
            const select = document.getElementById('selected-stock');
            select.innerHTML = '<option value="">Choose a stock to invest</option>';
            
            stockData.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock.symbol;
                option.textContent = `${stock.symbol} - $${stock.currentPrice.toFixed(2)}`;
                select.appendChild(option);
            });
        }

        // Add stock to portfolio
        function addToPortfolio() {
            const selectedSymbol = document.getElementById('selected-stock').value;
            const shares = parseInt(document.getElementById('investment-shares').value) || 0;
            
            if (!selectedSymbol || shares <= 0) {
                alert('Please select a stock and enter number of shares');
                return;
            }

            const stock = stockData.find(s => s.symbol === selectedSymbol);
            if (!stock) return;

            const investment = {
                symbol: stock.symbol,
                name: stock.name,
                shares: shares,
                purchasePrice: stock.currentPrice,
                purchaseDate: new Date().toLocaleDateString(),
                currentPrice: stock.currentPrice
            };

            const existingIndex = portfolio.findIndex(p => p.symbol === selectedSymbol);
            if (existingIndex >= 0) {
                const existing = portfolio[existingIndex];
                const totalShares = existing.shares + shares;
                const totalCost = (existing.shares * existing.purchasePrice) + (shares * stock.currentPrice);
                existing.shares = totalShares;
                existing.purchasePrice = totalCost / totalShares;
            } else {
                portfolio.push(investment);
            }

            document.getElementById('investment-shares').value = '';
            document.getElementById('selected-stock').value = '';
            
            savePortfolioData();
            updatePortfolioDisplay();
            generateInvestmentInsights();
        }

        // Update portfolio display
        function updatePortfolioDisplay() {
            const container = document.getElementById('portfolio-display');
            container.innerHTML = '';

            if (portfolio.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; grid-column: 1/-1;">No investments yet. Add stocks to start building your portfolio!</p>';
                updatePortfolioStats();
                return;
            }

            let totalInvested = 0;
            let currentValue = 0;

            portfolio.forEach((investment, index) => {
                const currentStock = stockData.find(s => s.symbol === investment.symbol);
                if (currentStock) {
                    investment.currentPrice = currentStock.currentPrice;
                }

                const investedAmount = investment.shares * investment.purchasePrice;
                const currentAmount = investment.shares * investment.currentPrice;
                const gainLoss = currentAmount - investedAmount;
                const returnPercent = (gainLoss / investedAmount) * 100;

                totalInvested += investedAmount;
                currentValue += currentAmount;

                const gainLossClass = gainLoss >= 0 ? 'positive' : 'negative';
                const gainLossSymbol = gainLoss >= 0 ? '+' : '';

                const portfolioItem = document.createElement('div');
                portfolioItem.className = 'portfolio-item';
                portfolioItem.innerHTML = `
                    <div class="portfolio-symbol">${investment.symbol}</div>
                    <div class="portfolio-details">
                        ${investment.name}<br>
                        üìä Shares: ${investment.shares}<br>
                        üí∞ Avg. Cost: $${investment.purchasePrice.toFixed(2)}<br>
                        üìà Current: $${investment.currentPrice.toFixed(2)}<br>
                        üìÖ Purchased: ${investment.purchaseDate}
                    </div>
                    <div class="portfolio-gain ${gainLossClass}">
                        ${gainLossSymbol}$${gainLoss.toFixed(2)} (${gainLossSymbol}${returnPercent.toFixed(1)}%)
                    </div>
                    <button onclick="removeFromPortfolio(${index})" style="margin-top: 10px; background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">Remove</button>
                `;
                container.appendChild(portfolioItem);
            });

            updatePortfolioStats();
            updatePortfolioChart();
        }

        // Remove investment from portfolio
        function removeFromPortfolio(index) {
            portfolio.splice(index, 1);
            savePortfolioData();
            updatePortfolioDisplay();
            generateInvestmentInsights();
        }

        // Update portfolio statistics
        function updatePortfolioStats() {
            let totalInvested = 0;
            let currentValue = 0;

            portfolio.forEach(investment => {
                totalInvested += investment.shares * investment.purchasePrice;
                currentValue += investment.shares * investment.currentPrice;
            });

            const totalGainLoss = currentValue - totalInvested;
            const portfolioReturn = totalInvested > 0 ? (totalGainLoss / totalInvested) * 100 : 0;

            document.getElementById('total-invested').textContent = `$${totalInvested.toFixed(2)}`;
            document.getElementById('current-value').textContent = `$${currentValue.toFixed(2)}`;
            document.getElementById('total-gain-loss').textContent = `${totalGainLoss >= 0 ? '+' : ''}$${totalGainLoss.toFixed(2)}`;
            document.getElementById('portfolio-return').textContent = `${portfolioReturn >= 0 ? '+' : ''}${portfolioReturn.toFixed(1)}%`;

            // Update colors based on performance
            const gainLossElement = document.getElementById('total-gain-loss');
            const returnElement = document.getElementById('portfolio-return');
            
            if (totalGainLoss >= 0) {
                gainLossElement.style.color = '#28a745';
                returnElement.style.color = '#28a745';
            } else {
                gainLossElement.style.color = '#dc3545';
                returnElement.style.color = '#dc3545';
            }
        }

        // Update portfolio chart
        function updatePortfolioChart() {
            const ctx = document.getElementById('portfolioChart').getContext('2d');
            
            if (portfolioChart) {
                portfolioChart.destroy();
            }

            if (portfolio.length === 0) {
                return;
            }

            const labels = portfolio.map(p => p.symbol);
            const investedData = portfolio.map(p => p.shares * p.purchasePrice);
            const currentData = portfolio.map(p => p.shares * p.currentPrice);

            portfolioChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Amount Invested',
                            data: investedData,
                            backgroundColor: 'rgba(102, 126, 234, 0.7)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Current Value',
                            data: currentData,
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return ' + value.toFixed(0)'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Start automatic price updates
        function startPriceUpdates() {
            // Update every 5 minutes to respect API rate limits
            priceUpdateInterval = setInterval(() => {
                updateStockPrices();
            }, 300000); // 5 minutes
        }

        // Update stock prices with real-time data
        async function updateStockPrices() {
            if (stockData.length === 0) return;

            try {
                const symbols = stockData.map(s => s.symbol);
                const updatedPrices = await fetchStockDataYahoo(symbols);

                if (updatedPrices) {
                    stockData.forEach(stock => {
                        const updated = updatedPrices.find(p => p.symbol === stock.symbol);
                        if (updated) {
                            stock.currentPrice = updated.currentPrice;
                            stock.change = updated.changePercent;
                            stock.lastUpdated = updated.lastUpdated;
                            stock.isDemo = false;
                        }
                    });
                } else {
                    // Fallback: simulate small price movements
                    stockData.forEach(stock => {
                        const changePercent = (Math.random() - 0.5) * 0.02; // ¬±1% change
                        stock.currentPrice *= (1 + changePercent);
                        stock.change = changePercent * 100;
                        stock.lastUpdated = new Date();
                    });
                }

                // Update displays if we have recommendations showing
                if (stockData.length > 0) {
                    const amount = parseFloat(document.getElementById('investment-amount').value) || 1000;
                    displayStockRecommendations(amount);
                    updateStockSelect();
                }

                updatePortfolioDisplay();
                savePortfolioData();

            } catch (error) {
                console.error('Error updating stock prices:', error);
            }
        }

        // Refresh all data with real-time updates
        async function refreshAllData() {
            const btn = document.querySelector('.refresh-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üîÑ Updating...';
            btn.disabled = true;

            try {
                await updateStockPrices();
                updatePortfolioDisplay();
                generateInvestmentInsights();
                
                btn.innerHTML = '‚úÖ Updated!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                btn.innerHTML = '‚ùå Update Failed';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Generate investment insights
        function generateInvestmentInsights() {
            const container = document.getElementById('investment-insights-container');
            const insights = [];

            if (portfolio.length === 0) {
                insights.push({
                    title: 'üöÄ Start Your Investment Journey',
                    content: 'You haven\'t made any investments yet. Consider starting with a diversified portfolio of 3-5 stocks across different sectors to reduce risk. Use real-time data to make informed decisions.'
                });
            } else {
                // Portfolio performance analysis
                let totalInvested = 0;
                let currentValue = 0;
                const sectors = {};

                portfolio.forEach(investment => {
                    totalInvested += investment.shares * investment.purchasePrice;
                    currentValue += investment.shares * investment.currentPrice;
                    
                    const stock = stockData.find(s => s.symbol === investment.symbol);
                    if (stock) {
                        sectors[stock.sector] = (sectors[stock.sector] || 0) + 1;
                    }
                });

                const totalReturn = ((currentValue - totalInvested) / totalInvested) * 100;

                // Performance insight
                if (totalReturn > 5) {
                    insights.push({
                        title: 'üéâ Strong Portfolio Performance',
                        content: `Your portfolio is performing well with a ${totalReturn.toFixed(1)}% return. Based on real-time data, consider taking some profits or rebalancing if any single position becomes too large.`
                    });
                } else if (totalReturn < -5) {
                    insights.push({
                        title: '‚ö†Ô∏è Portfolio Underperforming',
                        content: `Your portfolio is down ${Math.abs(totalReturn).toFixed(1)}%. Review current market conditions and consider averaging down on strong companies or cutting losses on weaker positions.`
                    });
                }

                // Real-time market analysis
                if (stockData.length > 0) {
                    const realTimeStocks = stockData.filter(s => !s.isDemo);
                    const demoStocks = stockData.filter(s => s.isDemo);
                    
                    if (realTimeStocks.length > 0) {
                        const avgChange = realTimeStocks.reduce((sum, stock) => sum + stock.change, 0) / realTimeStocks.length;
                        
                        if (avgChange > 2) {
                            insights.push({
                                title: 'üìà Market Rally Detected',
                                content: `Real-time data shows strong market momentum with an average gain of ${avgChange.toFixed(1)}% across tracked stocks. Consider taking profits or preparing for potential pullbacks.`
                            });
                        } else if (avgChange < -2) {
                            insights.push({
                                title: 'üìâ Market Correction Underway',
                                content: `Real-time data indicates a market correction with an average decline of ${Math.abs(avgChange).toFixed(1)}%. This could be an opportunity to add to quality positions at lower prices.`
                            });
                        }
                    }

                    if (demoStocks.length > 0) {
                        insights.push({
                            title: 'üî¥ API Limitation Notice',
                            content: `${demoStocks.length} stock(s) are using demo data due to API rate limits. Consider upgrading to a premium API plan for complete real-time coverage.`
                        });
                    }
                }

                // Diversification analysis
                const sectorCount = Object.keys(sectors).length;
                if (sectorCount < 3 && portfolio.length > 3) {
                    insights.push({
                        title: 'üìä Diversification Opportunity',
                        content: `Your portfolio is concentrated in ${sectorCount} sector(s). Consider diversifying across more sectors to reduce risk. Technology, healthcare, and consumer goods are traditionally stable sectors.`
                    });
                }

                // Position size analysis
                const positions = portfolio.map(p => p.shares * p.currentPrice);
                const maxPosition = Math.max(...positions);
                const portfolioValue = positions.reduce((sum, pos) => sum + pos, 0);
                const maxPositionPercent = (maxPosition / portfolioValue) * 100;

                if (maxPositionPercent > 40) {
                    const largestStock = portfolio[positions.indexOf(maxPosition)];
                    insights.push({
                        title: '‚öñÔ∏è Position Size Warning',
                        content: `${largestStock.symbol} represents ${maxPositionPercent.toFixed(1)}% of your portfolio. Consider rebalancing to avoid overconcentration risk. Generally, no single position should exceed 20-25% of your portfolio.`
                    });
                }

                // Volatility analysis
                const highVolatilityStocks = portfolio.filter(p => {
                    const stock = stockData.find(s => s.symbol === p.symbol);
                    return stock && Math.abs(stock.change) > 5;
                });

                if (highVolatilityStocks.length > 0) {
                    insights.push({
                        title: '‚ö° High Volatility Alert',
                        content: `${highVolatilityStocks.map(s => s.symbol).join(', ')} showing high volatility (>5% daily movement). Monitor these positions closely and consider position sizing based on your risk tolerance.`
                    });
                }

                // Data freshness insight
                const oldestUpdate = Math.min(...stockData.map(s => s.lastUpdated.getTime()));
                const minutesOld = (Date.now() - oldestUpdate) / (1000 * 60);
                
                if (minutesOld > 30) {
                    insights.push({
                        title: '‚è∞ Data Freshness Notice',
                        content: `Some stock data is ${Math.floor(minutesOld)} minutes old. Click "Refresh Market Data" to get the latest prices for more accurate portfolio analysis.`
                    });
                }
            }

            // Render insights
            container.innerHTML = '';
            insights.forEach(insight => {
                const div = document.createElement('div');
                div.className = 'insight-item';
                div.innerHTML = `
                    <h5>${insight.title}</h5>
                    <p>${insight.content}</p>
                `;
                container.appendChild(div);
            });

            if (insights.length === 0) {
                container.innerHTML = '<div class="insight-item"><h5>üìä Portfolio Analysis</h5><p>Add more investments to get detailed portfolio insights and recommendations based on real-time market data.</p></div>';
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
        });

        // Initialize insights on load
        setTimeout(generateInvestmentInsights, 1000);
    </script>
</body>
</html>